#include<reg52.h>

#define DISPLAY_RIGION 1
#define DISPLAY_RACK 2
#define FULL_TYPE 1
#define HALF_TYPE 2
#define LEFT_POS 1
#define CENTER_POS 2
#define RIGHT_POS 3
sbit T_CLK = P2^7;      //时钟 对应sk
sbit T_STR = P2^6;      //锁存 对应lt
sbit T_IO  = P2^5;       //数据1
sbit T_IO2  = P2^4;       //数据2
sbit OE=P3^6;
sfr P2M1=0x95;
sfr P2M0=0x96;

unsigned char displayType=1, address;
unsigned char tab[8];
unsigned char DIS[]={0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15};

/*unsigned char code hztest[]=   
{
0x0,0x0,0x0,0x4,0xff,0xfe,0x4,0x40,0x4,0x40,0x4,0x44,0x7f,0xfe,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x48,0x34,0x50,0x4,0x40,0x4,0x7f,0xfc,0x40,0x4,0x2,0x0,0x1,0x0,0x7f,0xfe,0x40,0x2,0x82,0x4,0x2,0x0,0x2,0x4,0xff,0xfe,0x4,0x20,0x8,0x20,0x18,0x20,0x6,0x40,0x1,0x80,0x2,0x40,0xc,0x30,0x30,0x10,0x0,0x38,0x3f,0xc0,0x1,0x4,0xff,0xfe,0x1,0x10,0x1f,0xf8,0x11,0x10,0x1f,0xf0,0x11,0x10,0x1f,0xf0,0x1,0x0,0x3f,0xf8,0x1,0x0,0x1,0x4,0xff,0xfe,0x0,0x0,0x8,0x40,0x48,0x48,0x2b,0xfc,0x8,0x40,0x18,0x50,0x29,0xf8,0x4a,0x0,0x9,0x4,0xff,0xfe,0x2,0x8,0x4,0x90,0xc,0xa0,0x14,0x40,0x65,0x30,0x6,0xe,0x4,0x4,
0x1,0x0,0x21,0x8,0x11,0xc,0x9,0x10,0x9,0x20,0x1,0x4,0xff,0xfe,0x4,0x40,0x4,0x40,0x4,0x40,0x4,0x40,0x8,0x40,0x8,0x42,0x10,0x42,0x20,0x3e,0x40,0x0,0x2,0x0,0x2,0x0,0x2,0x10,0x7f,0xf8,0x42,0x10,0x42,0x10,0x7f,0xf0,0x42,0x10,0x42,0x10,0x7f,0xf0,0x42,0x10,0x2,0x0,0x2,0x4,0x2,0x4,0x1,0xfc,0x0,0x0,0x10,0x40,0x10,0x40,0x10,0x48,0x13,0xfc,0xfc,0x40,0x10,0x40,0x10,0x40,0x13,0xf8,0x1a,0x8,0x31,0x10,0xd1,0x10,0x10,0xa0,0x10,0x40,0x10,0xb0,0x51,0xe,0x26,0x4,0x1,0x0,0x1,0x40,0x1,0x30,0x1,0x10,0x1,0x4,0xff,0xfe,0x1,0x0,0x3,0x80,0x5,0x40,0x9,0x20,0x11,0x10,0x21,0xe,0xc1,0x4,0x1,0x0,0x1,0x0,0x1,0x0,

};
*/
unsigned char code fixedChar[]={
/*--  文字:  区  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x00,0x00,0x7F,0xFC,0x40,0x20,0x40,0x30,0x48,0x20,0x46,0x40,0x41,0x40,0x40,0x80,
0x41,0x40,0x42,0x20,0x44,0x30,0x48,0x18,0x50,0x10,0x7F,0xFC,0x00,0x00,0x00,0x00,

/*--  文字:  架  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=16x16   --*/
0x08,0x00,0x08,0x00,0x7F,0x7C,0x09,0x44,0x09,0x44,0x11,0x44,0x15,0x7C,0x62,0x00,
0x01,0x00,0x7F,0xFC,0x03,0x80,0x05,0x40,0x09,0x30,0x31,0x0E,0xC1,0x04,0x01,0x00,
};
unsigned char code fixedNum[]={
/*--  文字:  0  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00,

/*--  文字:  1  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x10,0x70,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,

/*--  文字:  2  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x04,0x04,0x08,0x10,0x20,0x42,0x7E,0x00,0x00,

/*--  文字:  3  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3C,0x42,0x42,0x04,0x18,0x04,0x02,0x02,0x42,0x44,0x38,0x00,0x00,

/*--  文字:  4  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x04,0x0C,0x14,0x24,0x24,0x44,0x44,0x7E,0x04,0x04,0x1E,0x00,0x00,

/*--  文字:  5  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x7E,0x40,0x40,0x40,0x58,0x64,0x02,0x02,0x42,0x44,0x38,0x00,0x00,

/*--  文字:  6  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x1C,0x24,0x40,0x40,0x58,0x64,0x42,0x42,0x42,0x24,0x18,0x00,0x00,

/*--  文字:  7  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x7E,0x44,0x44,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00,

/*--  文字:  8  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x24,0x18,0x24,0x42,0x42,0x42,0x3C,0x00,0x00,

/*--  文字:  9  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x26,0x1A,0x02,0x02,0x24,0x38,0x00,0x00,
};
unsigned char code fixedAlpha[]={
/*--  文字  空格 --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/*--  文字:  A  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x10,0x10,0x18,0x28,0x28,0x24,0x3C,0x44,0x42,0x42,0xE7,0x00,0x00,

/*--  文字:  B  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xF8,0x44,0x44,0x44,0x78,0x44,0x42,0x42,0x42,0x44,0xF8,0x00,0x00,

/*--  文字:  C  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3E,0x42,0x42,0x80,0x80,0x80,0x80,0x80,0x42,0x44,0x38,0x00,0x00,

/*--  文字:  D  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xF8,0x44,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x44,0xF8,0x00,0x00,

/*--  文字:  E  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xFC,0x42,0x48,0x48,0x78,0x48,0x48,0x40,0x42,0x42,0xFC,0x00,0x00,

/*--  文字:  F  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xFC,0x42,0x48,0x48,0x78,0x48,0x48,0x40,0x40,0x40,0xE0,0x00,0x00,

/*--  文字:  G  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3C,0x44,0x44,0x80,0x80,0x80,0x8E,0x84,0x44,0x44,0x38,0x00,0x00,

/*--  文字:  H  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,

/*--  文字:  I  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,

/*--  文字:  J  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x88,0xF0,

/*--  文字:  K  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xEE,0x44,0x48,0x50,0x70,0x50,0x48,0x48,0x44,0x44,0xEE,0x00,0x00,

/*--  文字:  L  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xE0,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x42,0xFE,0x00,0x00,

/*--  文字:  M  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xEE,0x6C,0x6C,0x6C,0x6C,0x54,0x54,0x54,0x54,0x54,0xD6,0x00,0x00,

/*--  文字:  N  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xC7,0x62,0x62,0x52,0x52,0x4A,0x4A,0x4A,0x46,0x46,0xE2,0x00,0x00,

/*--  文字:  O  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0x82,0x82,0x44,0x38,0x00,0x00,

/*--  文字:  P  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xFC,0x42,0x42,0x42,0x42,0x7C,0x40,0x40,0x40,0x40,0xE0,0x00,0x00,

/*--  文字:  Q  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x38,0x44,0x82,0x82,0x82,0x82,0x82,0xB2,0xCA,0x4C,0x38,0x06,0x00,

/*--  文字:  R  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xFC,0x42,0x42,0x42,0x7C,0x48,0x48,0x44,0x44,0x42,0xE3,0x00,0x00,

/*--  文字:  S  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x3E,0x42,0x42,0x40,0x20,0x18,0x04,0x02,0x42,0x42,0x7C,0x00,0x00,

/*--  文字:  T  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xFE,0x92,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x38,0x00,0x00,

/*--  文字:  U  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,

/*--  文字:  V  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xE7,0x42,0x42,0x44,0x24,0x24,0x28,0x28,0x18,0x10,0x10,0x00,0x00,

/*--  文字:  W  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xD6,0x92,0x92,0x92,0x92,0xAA,0xAA,0x6C,0x44,0x44,0x44,0x00,0x00,

/*--  文字:  X  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x18,0x18,0x18,0x24,0x24,0x42,0xE7,0x00,0x00,

/*--  文字:  Y  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0xEE,0x44,0x44,0x28,0x28,0x10,0x10,0x10,0x10,0x10,0x38,0x00,0x00,

/*--  文字:  Z  --*/
/*--  宋体12;  此字体下对应的点阵为：宽x高=8x16   --*/
0x00,0x00,0x00,0x7E,0x84,0x04,0x08,0x08,0x10,0x20,0x20,0x42,0x42,0xFC,0x00,0x00,


};
unsigned char xdata strBuffer[128]={
0x00
};
void delayUs2x(unsigned char t) {
	while (--t)
		;
}

void delayMs(unsigned int t) {

	while (t--) {

		delayUs2x(245);
		delayUs2x(245);
	}
}
void InputByte(unsigned  char ucDa) 
{ 
	unsigned char i;
	for(i=8; i>0; i--)
	{
		T_IO = !((ucDa>>7)&0x01); 
		T_CLK =	0;                  
		T_CLK = 1;
		ucDa=ucDa<<1;
	} 
}


void Init_Timer1(void)
{
	TMOD |= 0x10;			     
	TH1=0xff;	             
	TL1=0x00;
	EA=1;                    
	ET1=1;                     
	TR1=1;                   
}
void displayChar(unsigned char *charIndex,unsigned char x,unsigned char type,unsigned char pos){
	unsigned char i;

	if(type==FULL_TYPE){
		for(i=0;i<32;i++)
		{
			strBuffer[x*32+i]=charIndex[i];
		}
	}else
	{
		if(pos==LEFT_POS){
			for(i=0;i<16;i++)
			{
				strBuffer[x*32+2*i]=charIndex[i];
			//	strBuffer[x*32+2*i+1]=0x00;
			}
		}
		else if(pos==RIGHT_POS){
			for(i=0;i<16;i++)
			{
			//	strBuffer[x*32+2*i]=0x00;
				strBuffer[x*32+2*i+1]=charIndex[i];
				
			}
		}
		else{
			for(i=0;i<16;i++)
			{
				strBuffer[x*32+2*i]=(charIndex[i]>>4)&0x0f;
				strBuffer[x*32+2*i+1]=(charIndex[i]<<4)&0xf0;
				
			}
		}
	}
	
}
void createDisplay(){
	if(displayType==DISPLAY_RACK)
	{
		displayChar(&fixedAlpha[16*address],0,HALF_TYPE,CENTER_POS);
		displayChar(&fixedChar[0],1,FULL_TYPE,LEFT_POS);
	}
	else{
		displayChar(&fixedNum[16*(address/10)],0,HALF_TYPE,LEFT_POS);
		displayChar(&fixedNum[16*(address%10)],0,HALF_TYPE,RIGHT_POS);

		displayChar(&fixedChar[1*32],1,FULL_TYPE,LEFT_POS);
	}
}
void inputSelection(){
//	delayMs(5000);
//	delayMs(5000);
//	delayMs(5000);
//	delayMs(5000);
//	delayMs(5000);
//	delayMs(5000);
	address=P0&0x0f;
	displayType=((P0>>7)&0x01)+1;
	address=(address)%26;
}
main()
{
	
	inputSelection();
	P2M0=0x0f;	
	OE=0;
	Init_Timer1(); 
	
	while(1)
	{ 
		inputSelection();
		createDisplay();
	}
}

void Timer1_isr(void) interrupt 3 using 1
{
	static unsigned char count=0,j;
	static unsigned char i;
	TH1=0xfe;		
	TL1=0x00; 
	for(j=0;j<4;j++) 
	{
		InputByte(strBuffer[j*32+i]);
		InputByte(strBuffer[j*32+i+1]);
	}
	T_STR=0; 
	T_STR=1; 
	P2=(P2&0xf0)|DIS[count];
	count++;
	i+=2;             
	if(count==16)
	count=0;
	if(i==32)
	{
		i=0;
	}
}


